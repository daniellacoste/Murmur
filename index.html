<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8"> <!-- specifies the character encoding for the HTML document -->
    <title>murmur</title>
    <link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>
    <div class="wrapper">
      <div id="error-container"></div>
      <button id="username-button" onclick="setUsername()">[click for random username]</button>
      <div class="messages-wrap" id="messages-wrap">
        <ul id="messages"></ul>
        <form id="messages-field" action="">
          <input id="messages-form" placeholder="type away..." autocomplete="off"/><button>SEND</button>
        </form>
      </div>
      <div class="users-wrap" style="display: none;">
        <ul id="users"></ul>
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var socket = io();
      var data;

      var $users= $("#users");
      var $usersWrap= $(".users-wrap");
      var $usernameButton = $("#username-button");

      var $msgList = $("#messages");
      var $msgWrap= $("#messages-wrap");
      var $msgField = $("#messages-field");
      var $msgForm = $("#messages-form");

      function setUsername(){
        socket.emit('setUsername', data);
      };

      // Display an alert if the random userid already exists 
      socket.on('userExists', function(data){
        alert("The username " + data + " is already taken!\nPlease randomize again.");
      });

      // Display an alert if the nickname already exists 
      socket.on('nickExists', function(data){
        alert("The nickname " + data + " is already taken!\nPlease try again.");
      });

      // When a new user is successfully generated, show CSS
      socket.on('newUser', function(data){
        userid = data.username;
        $usernameButton.hide();
        $msgForm.focus();
        $usersWrap.show();
      });
   
      // Print the users to the user area
      socket.on('getUsers', function(data){
        var html = '';
        for( i = 0; i < data.length; i++){
          html += '<li>' + data[i] + '</li>';
        }
        $users.html(html);
      });

      $msgField.submit(function(){
        socket.emit('msg', $msgForm.val());
        $msgForm.val(''); // clear message field 
        return false;
      });

      socket.on('msg', function(data){
        // append the message to the chat window 
        $msgList.append($('<li>' + '<span class=timestamp>(' + data.timestamp + ') </span>' +
          '<span class=userid style="color:#' + data.color + '">' + 
          data.userid + '</span>: ' +
          '<span class=message>' + data.message + '</li>'));

        $msgWrap.scrollTop(function () { return this.scrollHeight;}); // http://stackoverflow.com/questions/270612/scroll-to-bottom-of-div#comment34402222_2664878
      });
    </script>
  </body>
</html>

